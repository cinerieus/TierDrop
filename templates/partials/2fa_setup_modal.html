<div class="modal-backdrop" onclick="if(event.target===this)this.remove()">
    <div class="modal" style="max-width: 420px;">
        <div class="modal-header">
            <h3>Set Up Two-Factor Authentication</h3>
            <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">&times;</button>
        </div>
        <form hx-post="/settings/2fa/enable"
              hx-swap="none">
            <div class="modal-body">
                <div id="2fa-error"></div>
                <div class="form-group">
                    <label class="form-label">1. Scan this QR code with your authenticator app</label>
                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; margin: 8px 0;">
                        <img src="{{ qr_code_data_uri }}" alt="QR Code" style="width: 200px; height: 200px;">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">2. Or enter this secret manually</label>
                    <div class="secret-display" style="display: flex; align-items: center; gap: 8px;">
                        <input type="text" class="form-input mono" value="{{ secret }}" readonly
                               id="totp-secret" style="font-size: 0.85rem; letter-spacing: 0.05em;">
                        <button type="button" class="btn btn-sm" onclick="copySecret()" title="Copy to clipboard">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">3. Enter the 6-digit code to verify</label>
                    <input type="text" name="code" class="form-input mono"
                           placeholder="000000"
                           autocomplete="one-time-code"
                           inputmode="numeric"
                           pattern="[0-9\s]*"
                           maxlength="7"
                           required
                           style="text-align: center; font-size: 1.25rem; letter-spacing: 0.3em; max-width: 150px;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm" onclick="this.closest('.modal-backdrop').remove()">Cancel</button>
                <button type="submit" class="btn btn-primary btn-sm">
                    <span class="htmx-hide-on-request">Verify & Enable</span>
                    <span class="spinner htmx-indicator"></span>
                </button>
            </div>
        </form>
    </div>
</div>
<script>
function copySecret() {
    var input = document.getElementById('totp-secret');
    input.select();
    navigator.clipboard.writeText(input.value);
}

document.body.addEventListener('2fa-enabled', function() {
    var bd = document.querySelector('.modal-backdrop');
    if (bd) bd.remove();
    // Refresh the 2fa-status section
    fetch('/settings/2fa/status')
        .then(function(r) { return r.text(); })
        .then(function(html) {
            document.getElementById('2fa-status').innerHTML = html;
            htmx.process(document.getElementById('2fa-status'));
        });
}, {once: true});

document.body.addEventListener('2fa-error', function(evt) {
    var errorDiv = document.getElementById('2fa-error');
    if (errorDiv && evt.detail && evt.detail.message) {
        errorDiv.innerHTML = '<div class="alert alert-error">' + evt.detail.message + '</div>';
    }
}, {once: true});
</script>
